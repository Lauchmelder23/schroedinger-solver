#include "arrow.h"

#include <stdio.h>
#include <glad/glad.h>

#include "renderer/object.h"

static VertexArrayObject* vao = NULL;
static size_t num_arrows = 0;

static vec3 arrow_color = { 0.5f, 0.5f, 0.5f };

static int init_cube_object(void)
{
	vao = (VertexArrayObject*)malloc(sizeof(VertexArrayObject));
	if (vao == NULL)
	{
		fprintf(stderr, "Failed to allocate memory for cube vao\n");
		return 1;
	}

	create_vao(vao);
	float cube_vertices[] = {
		-30.0, 0.0, 1.0,			0.0, 2.93, 7.07,
		 30.0, 0.0, 1.0,			0.0, 2.93, 7.07,
		 30.0, 0.707, 0.707,		0.0, 2.93, 7.07,
		-30.0, 0.0, 1.0,			0.0, 2.93, 7.07,
		 30.0, 0.707, 0.707,		0.0, 2.93, 7.07,
		-30.0, 0.707, 0.707,		0.0, 2.93, 7.07,

		-30.0, 0.707, 0.707,		0.0, 7.07, 2.93,
		 30.0, 0.707, 0.707,		0.0, 7.07, 2.93,
		 30.0, 1.0, 0.0,			0.0, 7.07, 2.93,
		-30.0, 0.707, 0.707,		0.0, 7.07, 2.93,
		 30.0, 1.0, 0.0,			0.0, 7.07, 2.93,
		-30.0, 1.0, 0.0,			0.0, 7.07, 2.93,

		-30.0, 1.0, 0.0,			0.0, 7.07, -2.93,
		 30.0, 1.0, 0.0,			0.0, 7.07, -2.93,
		 30.0, 0.707, -0.707,		0.0, 7.07, -2.93,
		-30.0, 1.0, 0.0,			0.0, 7.07, -2.93,
		 30.0, 0.707, -0.707,		0.0, 7.07, -2.93,
		-30.0, 0.707, -0.707,		0.0, 7.07, -2.93,

		-30.0, 0.707, -0.707,		0.0, 2.93, -7.07,
		 30.0, 0.707, -0.707,		0.0, 2.93, -7.07,
		 30.0, 0.0, -1.0,			0.0, 2.93, -7.07,
		-30.0, 0.707, -0.707,		0.0, 2.93, -7.07,
		 30.0, 0.0, -1.0,			0.0, 2.93, -7.07,
		-30.0, 0.0, -1.0,			0.0, 2.93, -7.07,

		-30.0, -0.0, 1.0,			0.0, -2.93, 7.07,
		 30.0, -0.0, 1.0,			0.0, -2.93, 7.07,
		 30.0, -0.707, 0.707,		0.0, -2.93, 7.07,
		-30.0, -0.0, 1.0,			0.0, -2.93, 7.07,
		 30.0, -0.707, 0.707,		0.0, -2.93, 7.07,
		-30.0, -0.707, 0.707,		0.0, -2.93, 7.07,

		-30.0, -0.707, 0.707,		0.0, -7.07, 2.93,
		 30.0, -0.707, 0.707,		0.0, -7.07, 2.93,
		 30.0, -1.0, 0.0,			0.0, -7.07, 2.93,
		-30.0, -0.707, 0.707,		0.0, -7.07, 2.93,
		 30.0, -1.0, 0.0,			0.0, -7.07, 2.93,
		-30.0, -1.0, 0.0,			0.0, -7.07, 2.93,

		-30.0, -1.0, 0.0,			0.0, -7.07, -2.93,
		 30.0, -1.0, 0.0,			0.0, -7.07, -2.93,
		 30.0, -0.707, -0.707,		0.0, -7.07, -2.93,
		-30.0, -1.0, 0.0,			0.0, -7.07, -2.93,
		 30.0, -0.707, -0.707,		0.0, -7.07, -2.93,
		-30.0, -0.707, -0.707,		0.0, -7.07, -2.93,

		-30.0, -0.707, -0.707,		0.0, -2.93, -7.07,
		 30.0, -0.707, -0.707,		0.0, -2.93, -7.07,
		 30.0, -0.0, -1.0,			0.0, -2.93, -7.07,
		-30.0, -0.707, -0.707,		0.0, -2.93, -7.07,
		 30.0, -0.0, -1.0,			0.0, -2.93, -7.07,
		-30.0, -0.0, -1.0,			0.0, -2.93, -7.07,

		-30.0, 0.0, 1.0,			-1.0, 0.0, 0.0,
		-30.0, 0.707, 0.707,		-1.0, 0.0, 0.0,
		-30.0, -0.707, 0.707,		-1.0, 0.0, 0.0,
		-30.0, 1.0, 0.0,			-1.0, 0.0, 0.0,
		-30.0, 0.707, 0.707,		-1.0, 0.0, 0.0,
		-30.0, -0.707, 0.707,		-1.0, 0.0, 0.0,
		-30.0, 1.0, 0.0,			-1.0, 0.0, 0.0,
		-30.0, -0.707, 0.707,		-1.0, 0.0, 0.0,
		-30.0, -1.0, 0.0,			-1.0, 0.0, 0.0,
		-30.0, 0.0, -1.0,			-1.0, 0.0, 0.0,
		-30.0, 0.707, -0.707,		-1.0, 0.0, 0.0,
		-30.0, -0.707, -0.707,		-1.0, 0.0, 0.0,
		-30.0, 1.0, -0.0,			-1.0, 0.0, 0.0,
		-30.0, 0.707, -0.707,		-1.0, 0.0, 0.0,
		-30.0, -0.707, -0.707,		-1.0, 0.0, 0.0,
		-30.0, 1.0, -0.0,			-1.0, 0.0, 0.0,
		-30.0, -0.707, -0.707,		-1.0, 0.0, 0.0,
		-30.0, -1.0, -0.0,			-1.0, 0.0, 0.0,

		30.0, 0.0, 1.5,				-1.0, 0.0, 0.0,
		30.0, 1.0605, 1.0605,		-1.0, 0.0, 0.0,
		30.0, -1.0605, 1.0605,		-1.0, 0.0, 0.0,
		30.0, 1.5, 0.0,				-1.0, 0.0, 0.0,
		30.0, 1.0605, 1.0605,		-1.0, 0.0, 0.0,
		30.0, -1.0605, 1.0605,		-1.0, 0.0, 0.0,
		30.0, 1.5, 0.0,				-1.0, 0.0, 0.0,
		30.0, -1.0605, 1.0605,		-1.0, 0.0, 0.0,
		30.0, -1.5, 0.0,			-1.0, 0.0, 0.0,
		30.0, 0.0, -1.5,			-1.0, 0.0, 0.0,
		30.0, 1.0605, -1.0605,		-1.0, 0.0, 0.0,
		30.0, -1.0605, -1.0605,		-1.0, 0.0, 0.0,
		30.0, 1.5, -0.0,			-1.0, 0.0, 0.0,
		30.0, 1.0605, -1.0605,		-1.0, 0.0, 0.0,
		30.0, -1.0605, -1.0605,		-1.0, 0.0, 0.0,
		30.0, 1.5, -0.0,			-1.0, 0.0, 0.0,
		30.0, -1.0605, -1.0605,		-1.0, 0.0, 0.0,
		30.0, -1.5, -0.0,			-1.0, 0.0, 0.0,

		30.0, 0.0, 1.5,				1.59075, 1.3185, 3.1815,
		30.0, 1.0605, 1.0605,		1.59075, 1.3185, 3.1815,
		33.0, 0.0, 0.0,				1.59075, 1.3185, 3.1815,
		30.0, 1.0605, 1.0605,		1.59075, 3.1815, 1.3185,
		30.0, 1.5, 0.0,				1.59075, 3.1815, 1.3185,
		33.0, 0.0, 0.0,				1.59075, 3.1815, 1.3185,
		30.0, 1.5, 0.0,				1.59075, 3.1815, -1.3185,
		30.0, 1.0605, -1.0605,		1.59075, 3.1815, -1.3185,
		33.0, 0.0, 0.0,				1.59075, 3.1815, -1.3185,
		30.0, 1.0605, -1.0605,		1.59075, 1.3185, -3.1815,
		30.0, 0.0, -1.5,			1.59075, 1.3185, -3.1815,
		33.0, 0.0, 0.0,				1.59075, 1.3185, -3.1815,
		30.0, -0.0, 1.5,			1.59075, -1.3185, 3.1815,
		30.0, -1.0605, 1.0605,		1.59075, -1.3185, 3.1815,
		33.0, -0.0, 0.0,			1.59075, -1.3185, 3.1815,
		30.0, -1.0605, 1.0605,		1.59075, -3.1815, 1.3185,
		30.0, -1.5, 0.0,			1.59075, -3.1815, 1.3185,
		33.0, -0.0, 0.0,			1.59075, -3.1815, 1.3185,
		30.0, -1.5, 0.0,			1.59075, -3.1815, -1.3185,
		30.0, -1.0605, -1.0605,		1.59075, -3.1815, -1.3185,
		33.0, -0.0, 0.0,			1.59075, -3.1815, -1.3185,
		30.0, -1.0605, -1.0605,		1.59075, -1.3185, -3.1815,
		30.0, -0.0, -1.5,			1.59075, -1.3185, -3.1815,
		33.0, -0.0, 0.0,			1.59075, -1.3185, -3.1815,

	};
	attach_vertex_buffer(vao, cube_vertices, sizeof(cube_vertices));

	unsigned cube_indices[] = {
		0, 1, 2, 3, 4, 5,
		6, 7, 8, 9, 10, 11,
		12, 13, 14, 15, 16, 17,
		18, 19, 20, 21, 22, 23,
		24, 25, 26, 27, 28, 29,
		30, 31, 32, 33, 34, 35,
		36, 37, 38, 39, 40, 41,
		42, 43, 44, 45, 46, 47,
		48, 49, 50,
		51, 52, 53,
		54, 55, 56,
		57, 58, 59,
		60, 61, 62,
		63, 64, 65,
		66, 67, 68,
		69, 70, 71,
		72, 73, 74,
		75, 76, 77,
		78, 79, 80, 
		81, 82, 83,
		84, 85, 86,
		87, 88, 89,
		90, 91, 92,
		93, 94, 95,
		96, 97, 98,
		99, 100, 101,
		102, 103, 104,
		105, 106, 107
	};
	attach_element_buffer(vao, cube_indices, sizeof(cube_indices));

	VertexAttribute attributes[] = {
		{ GL_FLOAT, 3, sizeof(float) },
		{ GL_FLOAT, 3, sizeof(float) }
	};
	set_vertex_layout(vao, attributes, sizeof(attributes) / sizeof(VertexAttribute));

	return 0;
}

static void on_shader_bind(Arrow* cube, Shader* shader)
{
	set_uniform_vec3(shader, "object_color", arrow_color);
}

static void on_update(Arrow* cube)
{
	
}

int create_arrow(Arrow* arrow)
{
	if (vao == NULL)
	{
		if (init_cube_object() != 0)
		{
			return 1;
		}
	}

	init_object(arrow);
	arrow->vao = vao;

	arrow->child = arrow;
	arrow->on_shader_use_obj = on_shader_bind;
	arrow->on_update = on_update;
	arrow->on_destroy = destroy_arrow;

	num_arrows++;
}

void destroy_arrow(Arrow* arrow)
{
	num_arrows--;

	if (num_arrows == 0)
	{
		destroy_vao(*vao);
		vao = NULL;
	}
}